# Welcome to tmenv


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Disclaimer

This project is not actively maintained, may be outdated, and support is
not guaranteed. For potential assistance, try reaching out on
[Discord](https://discord.gg/cQyC4ydY).

**About PedroAI**  
tmenv is part of the PedroAI project
([trackmania-ai](https://github.com/trackmania-ai) on github), which I
began in April 2020. I streamed AI training on
[Twitch](https://www.twitch.tv/pedroaitm) from April 2021 to September
2023. I’ve since moved on to other projects and decided to open-source
PedroAI. For more details, check the
[blog](https://www.trackmania.ai/blog/).

**Platform & Tools**  
tmenv is intended for Linux (tested on Ubuntu 23.04) and uses
[nbdev](https://nbdev.fast.ai/getting_started.html) for development.

## Requirements

Have firejail, conda, pytorch and torchvision installed.

- Firejail is used to sandbox each environment and hide other
  environment input devices. Install it with
  `sudo apt-get install firejail`.
- I use miniconda to install conda
  https://docs.conda.io/en/latest/miniconda.html.
- I install pytorch and torchvision following
  https://pytorch.org/get-started/locally/.

## Installing tmenv

tmenv is not packaged yet and require an [editable
install](https://stackoverflow.com/questions/35064426/when-would-the-e-editable-option-be-useful-with-pip-install).
To install, clone this repo and run: `pip install -e ".[dev]"`.

## Installing Wine Prefix

1)  Install this version of wine
    https://github.com/GloriousEggroll/wine-ge-custom/releases/tag/GE-Proton8-13

- Download the tar.xz archive and extract its content where you like on
  your system
- Add
  `export PATH="$HOME/path/to/archive/content/lutris-GE-Proton8-13-x86_64/bin:$PATH"`
  to your bashrc file to make this your default wine install

2)  Download and unzip the wine prefix template from
    [here](https://e1.pcloud.link/publink/show?code=kZTHsFZqpiSB9EKm1H28V7L0rUhMFCl80Qk)
3)  Run the following command to launch the template:
    `USER=tmuser WINEPREFIX=/path/to/prefix/template wine explorer /desktop=template,1920x1080`
4)  Log with your Ubisoft Connect and change the following settings

- General : Disable all except Enable cloud save …
- Notifications : Disable all
- Account linking : Disable all

5)  Start Trackmania and change the following settings

- VIDEO
  - DISPLAY MODE : WINDOWED BORDERLESS
  - DYNAMIC RESOLUTION : DISABLED
  - FRAME RATE LIMIT : 150
  - V-SYNC : NONE
  - GPU & CPU SYNCHRONIZATION : NONE
  - CUSTOMIZE ADVANCED VIDEO SETTINGS : ENABLED
  - NICE ANTIALIASING : NONE
  - PRESET : VERY FAST
  - MOTION BLUR : DISABLED
- SOUND
  - ENABLE AUDIO : DISABLED
- CONTROLS
  - ANALOG DEAD ZONE : 0
- HUD
  - VISIBILITY OF THE CAR IN COCKPIT VIEW : TRANSPARENT
  - DEFAULT OPPONENT VISIBILITY : HIDDEN
- SYSTEM
  - SKIP THE START-UP SCREENS : ENABLED

6)  Start a race and change the camera to cockpit view (cam 3) and
    toggle ghost view by typing ‘g’ once.
7)  Configure the gamepad by running the script
    `python configure_gamepad.py name`. Change `name` with the name that
    you will use for trackmania environments. I use tmai1, tmai2, … Then
    open the binding prompt the script ask you to open in game. Press
    enter in the script to press the corresponding button in game.
    Repeat for each bind.
8)  Exit the game and Ubisoft Connect to close wine.
9)  Save the file under
    `/path/to/template/drive_c/users/tmuser/AppData/Local/Ubisoft Game Launcher/user.dat`
    somewhere else on your system. It is the file that store your
    Ubisoft Connect token. When using tmenv you should specify the path
    to the copy of that file in `credential_path` argument.
10) If you plan to launch several tmenv environments at the same time,
    repeat steps 3 to 8 for each Ubisoft Connect account you want to use
    for your environments.

## Enabling uinput

tmenv uses python-evdev to create virtual gamepads. Your user need to be
able to write to `/dev/uinput`. To do that :

1)  Create the file `/etc/udev/rules.d/99-uinput.rules` with root
    privilege and write `KERNEL=="uinput", GROUP:="input", MODE:="0660"`
    inside
2)  Add input group to your user with `sudo usermod -a -G input $USER`
3)  Restart your computer

## Optimizing input latency

I gained a few milliseconds of input lag by installing Liquorix Kernel
https://liquorix.net.
